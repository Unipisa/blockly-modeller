!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).Moddle={})}(this,(function(e){"use strict";const t=Object.prototype.toString,r=Object.prototype.hasOwnProperty;function n(e){return"[object String]"===t.call(e)}function i(e,t){return r.call(e,t)}function o(e,r){let n,o;if(void 0===e)return;const a=function(e){return"[object Array]"===t.call(e)}(e)?s:p;for(let t in e)if(i(e,t)&&(n=e[t],o=r(n,a(t)),!1===o))return n}function p(e){return e}function s(e){return Number(e)}function a(e,t){return e.bind(t)}function f(e,...t){return Object.assign(e,...t)}function y(){}function c(e,t){this.model=e,this.properties=t}y.prototype.get=function(e){return this.$model.properties.get(this,e)},y.prototype.set=function(e,t){this.$model.properties.set(this,e,t)},c.prototype.createType=function(e){var t=this.model,r=this.properties,n=Object.create(y.prototype);o(e.properties,(function(e){e.isMany||void 0===e.default||(n[e.name]=e.default)})),r.defineModel(n,t),r.defineDescriptor(n,e);var i=e.ns.name;function p(e){r.define(this,"$type",{value:i,enumerable:!0}),r.define(this,"$attrs",{value:{}}),r.define(this,"$parent",{writable:!0}),o(e,a((function(e,t){this.set(t,e)}),this))}return p.prototype=n,p.hasType=n.$instanceOf=this.model.hasType,r.defineModel(p,t),r.defineDescriptor(p,e),p};var u={String:!0,Boolean:!0,Integer:!0,Real:!0,Element:!0},d={String:function(e){return e},Boolean:function(e){return"true"===e},Integer:function(e){return parseInt(e,10)},Real:function(e){return parseFloat(e)}};function l(e){return!!u[e]}function h(e,t){var r,n,i=e.split(/:/);if(1===i.length)r=e,n=t;else{if(2!==i.length)throw new Error("expected <prefix:localName> or <localName>, got "+e);r=i[1],n=i[0]}return{name:e=(n?n+":":"")+r,prefix:n,localName:r}}function m(e){this.ns=e,this.name=e.name,this.allTypes=[],this.allTypesByName={},this.properties=[],this.propertiesByName={}}function g(e,t){this.packageMap={},this.typeMap={},this.packages=[],this.properties=t,o(e,a(this.registerPackage,this))}function v(e,t,r){var n=t[r];if(n in e)throw new Error("package with "+r+" <"+n+"> already defined")}function P(e){this.model=e}function b(e,t,r){Object.defineProperty(e,t.name,{enumerable:!t.isReference,writable:!0,value:r,configurable:!0})}function w(e){this.properties=new P(this),this.factory=new c(this,this.properties),this.registry=new g(e,this.properties),this.typeCache={}}m.prototype.build=function(){return function(e,t){let r={},n=Object(e);return o(t,(function(t){t in n&&(r[t]=e[t])})),r}(this,["ns","name","allTypes","allTypesByName","properties","propertiesByName","bodyProperty","idProperty"])},m.prototype.addProperty=function(e,t,r){"boolean"==typeof t&&(r=t,t=void 0),this.addNamedProperty(e,!1!==r);var n=this.properties;void 0!==t?n.splice(t,0,e):n.push(e)},m.prototype.replaceProperty=function(e,t,r){var n=e.ns,i=this.properties,o=this.propertiesByName,p=e.name!==t.name;if(e.isId){if(!t.isId)throw new Error("property <"+t.ns.name+"> must be id property to refine <"+e.ns.name+">");this.setIdProperty(t,!1)}if(e.isBody){if(!t.isBody)throw new Error("property <"+t.ns.name+"> must be body property to refine <"+e.ns.name+">");this.setBodyProperty(t,!1)}var s=i.indexOf(e);if(-1===s)throw new Error("property <"+n.name+"> not found in property list");i.splice(s,1),this.addProperty(t,r?void 0:s,p),o[n.name]=o[n.localName]=t},m.prototype.redefineProperty=function(e,t,r){var n=e.ns.prefix,i=t.split("#"),o=h(i[0],n),p=h(i[1],o.prefix).name,s=this.propertiesByName[p];if(!s)throw new Error("refined property <"+p+"> not found");this.replaceProperty(s,e,r),delete e.redefines},m.prototype.addNamedProperty=function(e,t){var r=e.ns,n=this.propertiesByName;t&&(this.assertNotDefined(e,r.name),this.assertNotDefined(e,r.localName)),n[r.name]=n[r.localName]=e},m.prototype.removeNamedProperty=function(e){var t=e.ns,r=this.propertiesByName;delete r[t.name],delete r[t.localName]},m.prototype.setBodyProperty=function(e,t){if(t&&this.bodyProperty)throw new Error("body property defined multiple times (<"+this.bodyProperty.ns.name+">, <"+e.ns.name+">)");this.bodyProperty=e},m.prototype.setIdProperty=function(e,t){if(t&&this.idProperty)throw new Error("id property defined multiple times (<"+this.idProperty.ns.name+">, <"+e.ns.name+">)");this.idProperty=e},m.prototype.assertNotDefined=function(e,t){var r=e.name,n=this.propertiesByName[r];if(n)throw new Error("property <"+r+"> already defined; override of <"+n.definedBy.ns.name+"#"+n.ns.name+"> by <"+e.definedBy.ns.name+"#"+e.ns.name+"> not allowed without redefines")},m.prototype.hasProperty=function(e){return this.propertiesByName[e]},m.prototype.addTrait=function(e,t){var r=this.allTypesByName,n=this.allTypes,i=e.name;i in r||(o(e.properties,a((function(r){r=f({},r,{name:r.ns.localName,inherited:t}),Object.defineProperty(r,"definedBy",{value:e});var n=r.replaces,i=r.redefines;n||i?this.redefineProperty(r,n||i,n):(r.isBody&&this.setBodyProperty(r),r.isId&&this.setIdProperty(r),this.addProperty(r))}),this)),n.push(e),r[i]=e)},g.prototype.getPackage=function(e){return this.packageMap[e]},g.prototype.getPackages=function(){return this.packages},g.prototype.registerPackage=function(e){e=f({},e);var t=this.packageMap;v(t,e,"prefix"),v(t,e,"uri"),o(e.types,a((function(t){this.registerType(t,e)}),this)),t[e.uri]=t[e.prefix]=e,this.packages.push(e)},g.prototype.registerType=function(e,t){var r=h((e=f({},e,{superClass:(e.superClass||[]).slice(),extends:(e.extends||[]).slice(),properties:(e.properties||[]).slice(),meta:f(e.meta||{})})).name,t.prefix),n=r.name,i={};o(e.properties,a((function(e){var t=h(e.name,r.prefix),n=t.name;l(e.type)||(e.type=h(e.type,t.prefix).name),f(e,{ns:t,name:n}),i[n]=e}),this)),f(e,{ns:r,name:n,propertiesByName:i}),o(e.extends,a((function(e){var t=this.typeMap[e];t.traits=t.traits||[],t.traits.push(n)}),this)),this.definePackage(e,t),this.typeMap[n]=e},g.prototype.mapTypes=function(e,t,r){var n=l(e.name)?{name:e.name}:this.typeMap[e.name],i=this;function p(e){return s(e,!0)}function s(r,n){var o=h(r,l(r)?"":e.prefix);i.mapTypes(o,t,n)}if(!n)throw new Error("unknown type <"+e.name+">");o(n.superClass,r?p:s),t(n,!r),o(n.traits,p)},g.prototype.getEffectiveDescriptor=function(e){var t=h(e),r=new m(t);this.mapTypes(t,(function(e,t){r.addTrait(e,t)}));var n=r.build();return this.definePackage(n,n.allTypes[n.allTypes.length-1].$pkg),n},g.prototype.definePackage=function(e,t){this.properties.define(e,"$pkg",{value:t})},P.prototype.set=function(e,t,r){if(!n(t)||!t.length)throw new TypeError("property name must be a non-empty string");var i=this.model.getPropertyDescriptor(e,t),o=i&&i.name;void 0===r?i?delete e[o]:delete e.$attrs[t]:i?o in e?e[o]=r:b(e,i,r):e.$attrs[t]=r},P.prototype.get=function(e,t){var r=this.model.getPropertyDescriptor(e,t);if(!r)return e.$attrs[t];var n=r.name;return!e[n]&&r.isMany&&b(e,r,[]),e[n]},P.prototype.define=function(e,t,r){if(!r.writable){var n=r.value;delete(r=f({},r,{get:function(){return n}})).value}Object.defineProperty(e,t,r)},P.prototype.defineDescriptor=function(e,t){this.define(e,"$descriptor",{value:t})},P.prototype.defineModel=function(e,t){this.define(e,"$model",{value:t})},w.prototype.create=function(e,t){var r=this.getType(e);if(!r)throw new Error("unknown type <"+e+">");return new r(t)},w.prototype.getType=function(e){var t=this.typeCache,r=n(e)?e:e.ns.name,i=t[r];return i||(e=this.registry.getEffectiveDescriptor(r),i=t[r]=this.factory.createType(e)),i},w.prototype.createAny=function(e,r,n){var i=h(e),p={$type:e,$instanceOf:function(e){return e===this.$type}},s={name:e,isGeneric:!0,ns:{prefix:i.prefix,localName:i.localName,uri:r}};return this.properties.defineDescriptor(p,s),this.properties.defineModel(p,this),this.properties.define(p,"$parent",{enumerable:!1,writable:!0}),this.properties.define(p,"$instanceOf",{enumerable:!1,writable:!0}),o(n,(function(e,r){var n;n=e,"[object Object]"===t.call(n)&&void 0!==e.value?p[e.name]=e.value:p[r]=e})),p},w.prototype.getPackage=function(e){return this.registry.getPackage(e)},w.prototype.getPackages=function(){return this.registry.getPackages()},w.prototype.getElementDescriptor=function(e){return e.$descriptor},w.prototype.hasType=function(e,t){return void 0===t&&(t=e,e=this),t in e.$model.getElementDescriptor(e).allTypesByName},w.prototype.getPropertyDescriptor=function(e,t){return this.getElementDescriptor(e).propertiesByName[t]},w.prototype.getTypeDescriptor=function(e){return this.registry.typeMap[e]},e.Moddle=w,e.coerceType=function(e,t){var r=d[e];return r?r(t):t},e.isBuiltInType=l,e.isSimpleType=function(e){return!!d[e]},e.parseNameNS=h,Object.defineProperty(e,"__esModule",{value:!0})}));
